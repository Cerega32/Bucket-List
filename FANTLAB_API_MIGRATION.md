# Миграция с Google Books API на FantLab API

## Обзор изменений

Функция поиска книг была переписана для использования FantLab API вместо Google Books API. FantLab предоставляет более подходящие результаты для поиска произведений и циклов книг, особенно российской фантастики.

## Основные изменения

### 1. Обновленная функция поиска (`backend/goals/views/external_api_views.py`)

**Было:** `search_books()` использовал Google Books API
**Стало:** `search_books()` использует FantLab API

**Ключевые изменения:**

-   URL изменен с `https://www.googleapis.com/books/v1/volumes` на `https://fantlab.ru/searchmain`
-   Параметры изменены с `{q, langRestrict, maxResults}` на `{searchstr}`
-   Добавлена функция `parse_fantlab_searchmain_response()` для парсинга ответа FantLab
-   Обновлена функция `parse_fantlab_json_response()` как резервный метод

### 2. Обновленная система rate limiting (`backend/goals/views/utils.py`)

**Изменения:**

-   Заменен `"google_books"` на `"fantlab"` в `api_request_tracking`
-   Установлен лимит 5 запросов в 10 секунд для FantLab (более консервативный)
-   Обновлены комментарии в функции очистки кэша

### 3. Структура данных ответа

**FantLab API возвращает:**

```json
{
	"external_id": "work_id или author_id",
	"title": "Название произведения",
	"description": "Тип произведения + автор",
	"image_url": "",
	"type": "book",
	"authors": ["Имя автора"],
	"published_date": "Год издания",
	"api_source": "fantlab",
	"additional_fields": {
		"authors": ["Имя автора"],
		"published_date": "Год издания",
		"work_type": "Тип произведения",
		"rating": "Рейтинг FantLab",
		"mark_count": "Количество оценок"
	}
}
```

## Преимущества FantLab API

1. **Специализация на фантастике**: FantLab специализируется на фантастической литературе
2. **Произведения vs издания**: Поиск по произведениям, а не по конкретным изданиям
3. **Циклы книг**: Поддержка поиска циклов произведений
4. **Российские авторы**: Лучшее покрытие российской фантастики
5. **Рейтинги**: Собственная система рейтингов FantLab
6. **Типы произведений**: Четкое разделение на романы, повести, рассказы и т.д.

## Типы результатов

### Произведения (works)

-   Романы, повести, рассказы
-   Информация об авторах, годе издания, рейтинге
-   Ключевые слова и описания

### Авторы (autors)

-   Информация об авторах
-   Годы жизни
-   Количество произведений

### Издания (editions)

-   Конкретные издания книг
-   Издательства, ISBN
-   Год издания

## Установка зависимостей

Для работы HTML-парсинга (резервный метод):

```bash
pip install beautifulsoup4
```

## Примеры поиска

### Поиск произведения

```python
# Поиск "Пикник на обочине"
results = search_books("Пикник на обочине")
# Вернет: произведение Стругацких с рейтингом 8.92
```

### Поиск автора

```python
# Поиск "Лукьяненко"
results = search_books("Лукьяненко")
# Вернет: автора + его произведения (Лабиринт отражений, Ночной Дозор)
```

### Поиск серии

```python
# Поиск "Метро 2033"
results = search_books("Метро 2033")
# Вернет: основное произведение + книги из серии
```

## Совместимость

API остается полностью совместимым с существующим кодом:

-   Те же параметры входа и выхода
-   Те же поля в ответе
-   Тот же формат данных для фронтенда

## Производительность

-   Кэширование результатов на 1 час
-   Rate limiting: 5 запросов в 10 секунд
-   Timeout: 10 секунд на запрос
-   Retry логика при ошибках

## Мониторинг

Логи содержат информацию о:

-   Успешных/неуспешных запросах
-   Rate limiting
-   Ошибках парсинга
-   Времени выполнения запросов
